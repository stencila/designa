var __extends=this&&this.__extends||function(){var t=function(e,n){t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)if(Object.prototype.hasOwnProperty.call(e,n))t[n]=e[n]};return t(e,n)};return function(e,n){if(typeof n!=="function"&&n!==null)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");t(e,n);function r(){this.constructor=e}e.prototype=n===null?Object.create(n):(r.prototype=n.prototype,new r)}}();import{L as Language,d as defineLanguageFacet,i as indentService,N as NodeProp,s as syntaxTree,T as Tree,a as NodeType,b as styleTags,l as languageDataProp,P as Parser,c as ParseContext,g as getIndentUnit,e as NodeSet,t as tags}from"./stencila-editor-a35809c0.js";import"./index-2305c23c.js";import"./slotSelectors-df70e421.js";import"./languageUtils-2c49a4c4.js";function countCol(t,e,n,r,s){if(r===void 0){r=0}if(s===void 0){s=0}if(e==null){e=t.search(/[^\s\u00a0]/);if(e==-1)e=t.length}var i=s;for(var a=r;a<e;a++){if(t.charCodeAt(a)==9)i+=n-i%n;else i++}return i}var StringStream=function(){function t(t,e,n){this.string=t;this.tabSize=e;this.indentUnit=n;this.pos=0;this.start=0;this.lastColumnPos=0;this.lastColumnValue=0}t.prototype.eol=function(){return this.pos>=this.string.length};t.prototype.sol=function(){return this.pos==0};t.prototype.peek=function(){return this.string.charAt(this.pos)||undefined};t.prototype.next=function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)};t.prototype.eat=function(t){var e=this.string.charAt(this.pos);var n;if(typeof t=="string")n=e==t;else n=e&&(t instanceof RegExp?t.test(e):t(e));if(n){++this.pos;return e}};t.prototype.eatWhile=function(t){var e=this.pos;while(this.eat(t)){}return this.pos>e};t.prototype.eatSpace=function(){var t=this.pos;while(/[\s\u00a0]/.test(this.string.charAt(this.pos)))++this.pos;return this.pos>t};t.prototype.skipToEnd=function(){this.pos=this.string.length};t.prototype.skipTo=function(t){var e=this.string.indexOf(t,this.pos);if(e>-1){this.pos=e;return true}};t.prototype.backUp=function(t){this.pos-=t};t.prototype.column=function(){if(this.lastColumnPos<this.start){this.lastColumnValue=countCol(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue);this.lastColumnPos=this.start}return this.lastColumnValue};t.prototype.indentation=function(){return countCol(this.string,null,this.tabSize)};t.prototype.match=function(t,e,n){if(typeof t=="string"){var r=function(t){return n?t.toLowerCase():t};var s=this.string.substr(this.pos,t.length);if(r(s)==r(t)){if(e!==false)this.pos+=t.length;return true}else return null}else{var i=this.string.slice(this.pos).match(t);if(i&&i.index>0)return null;if(i&&e!==false)this.pos+=i[0].length;return i}};t.prototype.current=function(){return this.string.slice(this.start,this.pos)};return t}();function fullParser(t){return{token:t.token,blankLine:t.blankLine||function(){},startState:t.startState||function(){return true},copyState:t.copyState||defaultCopyState,indent:t.indent||function(){return null},languageData:t.languageData||{},tokenTable:t.tokenTable||noTokens}}function defaultCopyState(t){if(typeof t!="object")return t;var e={};for(var n in t){var r=t[n];e[n]=r instanceof Array?r.slice():r}return e}var StreamLanguage=function(t){__extends(e,t);function e(e){var n=this;var r=defineLanguageFacet(e.languageData);var s=fullParser(e),i;var a=new(function(t){__extends(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}e.prototype.createParse=function(t,e,n){return new Parse(i,t,e,n)};return e}(Parser));n=t.call(this,r,a,docID(r),[indentService.of((function(t,e){return n.getIndent(t,e)}))])||this;i=n;n.streamParser=s;n.stateAfter=new NodeProp({perNode:true});n.tokenTable=e.tokenTable?new TokenTable(s.tokenTable):defaultTokenTable;return n}e.define=function(t){return new e(t)};e.prototype.getIndent=function(t,e){var n=syntaxTree(t.state),r=n.resolve(e);while(r&&r.type!=this.topNode)r=r.parent;if(!r)return null;var s=findState(this,n,0,r.from,e),i,a;if(s){a=s.state;i=s.pos+1}else{a=this.streamParser.startState(t.unit);i=0}if(e-i>1e4)return null;while(i<e){var o=t.state.doc.lineAt(i),h=Math.min(e,o.to);if(o.length){var u=new StringStream(o.text,t.state.tabSize,t.unit);while(u.pos<h-o.from)readToken(this.streamParser.token,u,a)}else{this.streamParser.blankLine(a,t.unit)}if(h==e)break;i=o.to+1}var l=t.lineAt(e).text;return this.streamParser.indent(a,/^\s*(.*)/.exec(l)[1],t)};Object.defineProperty(e.prototype,"allowsNesting",{get:function(){return false},enumerable:false,configurable:true});return e}(Language);function findState(t,e,n,r,s){var i=n>=r&&n+e.length<=s&&e.prop(t.stateAfter);if(i)return{state:t.streamParser.copyState(i),pos:n+e.length};for(var a=e.children.length-1;a>=0;a--){var o=e.children[a],h=n+e.positions[a];var u=o instanceof Tree&&h<s&&findState(t,o,h,r,s);if(u)return u}return null}function cutTree(t,e,n,r,s){if(s&&n<=0&&r>=e.length)return e;if(!s&&e.type==t.topNode)s=true;for(var i=e.children.length-1;i>=0;i--){var a=e.positions[i],o=e.children[i],h=void 0;if(a<r&&o instanceof Tree){if(!(h=cutTree(t,o,n-a,r-a,s)))break;return!s?h:new Tree(e.type,e.children.slice(0,i).concat(h),e.positions.slice(0,i+1),a+h.length)}}return null}function findStartInFragments(t,e,n,r){for(var s=0,i=e;s<i.length;s++){var a=i[s];var o=a.from+(a.openStart?25:0),h=a.to-(a.openEnd?25:0);var u=o<=n&&h>n&&findState(t,a.tree,0-a.offset,n,h),l=void 0;if(u&&(l=cutTree(t,a.tree,n+a.offset,u.pos+a.offset,false)))return{state:u.state,tree:l}}return{state:t.streamParser.startState(r?getIndentUnit(r):4),tree:Tree.empty}}var Parse=function(){function t(t,e,n,r){this.lang=t;this.input=e;this.fragments=n;this.ranges=r;this.stoppedAt=null;this.chunks=[];this.chunkPos=[];this.chunk=[];this.chunkReused=undefined;this.rangeIndex=0;this.to=r[r.length-1].to;var s=ParseContext.get(),i=r[0].from;var a=findStartInFragments(t,n,i,s===null||s===void 0?void 0:s.state),o=a.state,h=a.tree;this.state=o;this.parsedPos=this.chunkStart=i+h.length;for(var u=0;u<h.children.length;u++){this.chunks.push(h.children[u]);this.chunkPos.push(h.positions[u])}if(s&&this.parsedPos<s.viewport.from-1e5){this.state=this.lang.streamParser.startState(getIndentUnit(s.state));s.skipUntilInView(this.parsedPos,s.viewport.from);this.parsedPos=s.viewport.from}}t.prototype.advance=function(){var t=ParseContext.get();var e=this.stoppedAt==null?this.to:Math.min(this.to,this.stoppedAt);var n=Math.min(e,this.chunkStart+2048);if(t)n=Math.min(n,t.viewport.to);while(this.parsedPos<n)this.parseLine(t);if(this.chunkStart<this.parsedPos)this.finishChunk();if(this.parsedPos>=e)return this.finish();if(t&&this.parsedPos>=t.viewport.to){t.skipUntilInView(this.parsedPos,e);return this.finish()}return null};t.prototype.stopAt=function(t){this.stoppedAt=t};t.prototype.lineAfter=function(t){var e=this.input.chunk(t);if(!this.input.lineChunks){var n=e.indexOf("\n");if(n>-1)e=e.slice(0,n)}else if(e=="\n"){e=""}return t+e.length<=this.to?e:e.slice(0,this.to-t)};t.prototype.nextLine=function(){var t=this.parsedPos,e=this.lineAfter(t),n=t+e.length;for(var r=this.rangeIndex;;){var s=this.ranges[r].to;if(s>=n)break;e=e.slice(0,s-(n-e.length));r++;if(r==this.ranges.length)break;var i=this.ranges[r].from;var a=this.lineAfter(i);e+=a;n=i+a.length}return{line:e,end:n}};t.prototype.skipGapsTo=function(t,e,n){for(;;){var r=this.ranges[this.rangeIndex].to,s=t+e;if(n>0?r>s:r>=s)break;var i=this.ranges[++this.rangeIndex].from;e+=i-r}return e};t.prototype.emitToken=function(t,e,n,r,s){if(this.ranges.length>1){s=this.skipGapsTo(e,s,1);e+=s;var i=this.chunk.length;s=this.skipGapsTo(n,s,-1);n+=s;r+=this.chunk.length-i}this.chunk.push(t,e,n,r);return s};t.prototype.parseLine=function(t){var e=this.nextLine(),n=e.line,r=e.end,s=0,i=this.lang.streamParser;var a=new StringStream(n,t?t.state.tabSize:4,t?getIndentUnit(t.state):2);if(a.eol()){i.blankLine(this.state,a.indentUnit)}else{while(!a.eol()){var o=readToken(i.token,a,this.state);if(o)s=this.emitToken(this.lang.tokenTable.resolve(o),this.parsedPos+a.start,this.parsedPos+a.pos,4,s);if(a.start>1e4)break}}this.parsedPos=r;if(this.parsedPos<this.to)this.parsedPos++};t.prototype.finishChunk=function(){var t=Tree.build({buffer:this.chunk,start:this.chunkStart,length:this.parsedPos-this.chunkStart,nodeSet:nodeSet,topID:0,maxBufferLength:2048,reused:this.chunkReused});t=new Tree(t.type,t.children,t.positions,t.length,[[this.lang.stateAfter,this.lang.streamParser.copyState(this.state)]]);this.chunks.push(t);this.chunkPos.push(this.chunkStart-this.ranges[0].from);this.chunk=[];this.chunkReused=undefined;this.chunkStart=this.parsedPos};t.prototype.finish=function(){return new Tree(this.lang.topNode,this.chunks,this.chunkPos,this.parsedPos-this.ranges[0].from).balance()};return t}();function readToken(t,e,n){e.start=e.pos;for(var r=0;r<10;r++){var s=t(e,n);if(e.pos>e.start)return s}throw new Error("Stream parser failed to advance stream.")}var noTokens=Object.create(null);var typeArray=[NodeType.none];var nodeSet=new NodeSet(typeArray);var warned=[];var defaultTable=Object.create(null);for(var _i=0,_a=[["variable","variableName"],["variable-2","variableName.special"],["string-2","string.special"],["def","variableName.definition"],["tag","typeName"],["attribute","propertyName"],["type","typeName"],["builtin","variableName.standard"],["qualifier","modifier"],["error","invalid"],["header","heading"],["property","propertyName"]];_i<_a.length;_i++){var _b=_a[_i],legacyName=_b[0],name=_b[1];defaultTable[legacyName]=createTokenType(noTokens,name)}var TokenTable=function(){function t(t){this.extra=t;this.table=Object.assign(Object.create(null),defaultTable)}t.prototype.resolve=function(t){return!t?0:this.table[t]||(this.table[t]=createTokenType(this.extra,t))};return t}();var defaultTokenTable=new TokenTable(noTokens);function warnForPart(t,e){if(warned.indexOf(t)>-1)return;warned.push(t);console.warn(e)}function createTokenType(t,e){var n;var r=null;for(var s=0,i=e.split(".");s<i.length;s++){var a=i[s];var o=t[a]||tags[a];if(!o){warnForPart(a,"Unknown highlighting tag ".concat(a))}else if(typeof o=="function"){if(!r)warnForPart(a,"Modifier ".concat(a," used at start of tag"));else r=o(r)}else{if(r)warnForPart(a,"Tag ".concat(a," used as modifier"));else r=o}}if(!r)return 0;var h=e.replace(/ /g,"_"),u=NodeType.define({id:typeArray.length,name:h,props:[styleTags((n={},n[h]=r,n))]});typeArray.push(u);return u.id}function docID(t){var e=NodeType.define({id:typeArray.length,name:"Document",props:[languageDataProp.add((function(){return t}))]});typeArray.push(e);return e}export{StreamLanguage,StringStream};
//# sourceMappingURL=index-3b0b5738.js.map
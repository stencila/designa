var __extends=this&&this.__extends||function(){var t=function(e,r){t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r))t[r]=e[r]};return t(e,r)};return function(e,r){if(typeof r!=="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");t(e,r);function s(){this.constructor=e}e.prototype=r===null?Object.create(r):(s.prototype=r.prototype,new s)}}();import{P as Parser,e as NodeSet,a as NodeType,D as DefaultBufferLength,N as NodeProp,T as Tree}from"./stencila-editor-a35809c0.js";var Stack=function(){function t(t,e,r,s,i,n,o,a,h,f,u){if(f===void 0){f=0}this.p=t;this.stack=e;this.state=r;this.reducePos=s;this.pos=i;this.score=n;this.buffer=o;this.bufferBase=a;this.curContext=h;this.lookAhead=f;this.parent=u}t.prototype.toString=function(){return"[".concat(this.stack.filter((function(t,e){return e%3==0})).concat(this.state),"]@").concat(this.pos).concat(this.score?"!"+this.score:"")};t.start=function(e,r,s){if(s===void 0){s=0}var i=e.parser.context;return new t(e,[],r,s,s,0,[],0,i?new StackContext(i,i.start):null,0,null)};Object.defineProperty(t.prototype,"context",{get:function(){return this.curContext?this.curContext.context:null},enumerable:false,configurable:true});t.prototype.pushState=function(t,e){this.stack.push(this.state,e,this.bufferBase+this.buffer.length);this.state=t};t.prototype.reduce=function(t){var e=t>>19,r=t&65535;var s=this.p.parser;var i=s.dynamicPrecedence(r);if(i)this.score+=i;if(e==0){this.pushState(s.getGoto(this.state,r,true),this.reducePos);if(r<s.minRepeatTerm)this.storeNode(r,this.reducePos,this.reducePos,4,true);this.reduceContext(r,this.reducePos);return}var n=this.stack.length-(e-1)*3-(t&262144?6:0);var o=this.stack[n-2];var a=this.stack[n-1],h=this.bufferBase+this.buffer.length-a;if(r<s.minRepeatTerm||t&131072){var f=s.stateFlag(this.state,1)?this.pos:this.reducePos;this.storeNode(r,o,f,h+4,true)}if(t&262144){this.state=this.stack[n]}else{var u=this.stack[n-3];this.state=s.getGoto(u,r,true)}while(this.stack.length>n)this.stack.pop();this.reduceContext(r,o)};t.prototype.storeNode=function(t,e,r,s,i){if(s===void 0){s=4}if(i===void 0){i=false}if(t==0){var n=this,o=this.buffer.length;if(o==0&&n.parent){o=n.bufferBase-n.parent.bufferBase;n=n.parent}if(o>0&&n.buffer[o-4]==0&&n.buffer[o-1]>-1){if(e==r)return;if(n.buffer[o-2]>=e){n.buffer[o-2]=r;return}}}if(!i||this.pos==r){this.buffer.push(t,e,r,s)}else{var a=this.buffer.length;if(a>0&&this.buffer[a-4]!=0)while(a>0&&this.buffer[a-2]>r){this.buffer[a]=this.buffer[a-4];this.buffer[a+1]=this.buffer[a-3];this.buffer[a+2]=this.buffer[a-2];this.buffer[a+3]=this.buffer[a-1];a-=4;if(s>4)s-=4}this.buffer[a]=t;this.buffer[a+1]=e;this.buffer[a+2]=r;this.buffer[a+3]=s}};t.prototype.shift=function(t,e,r){var s=this.pos;if(t&131072){this.pushState(t&65535,this.pos)}else if((t&262144)==0){var i=t,n=this.p.parser;if(r>this.pos||e<=n.maxNode){this.pos=r;if(!n.stateFlag(i,1))this.reducePos=r}this.pushState(i,s);this.shiftContext(e,s);if(e<=n.maxNode)this.buffer.push(e,s,r,4)}else{this.pos=r;this.shiftContext(e,s);if(e<=this.p.parser.maxNode)this.buffer.push(e,s,r,4)}};t.prototype.apply=function(t,e,r){if(t&65536)this.reduce(t);else this.shift(t,e,r)};t.prototype.useNode=function(t,e){var r=this.p.reused.length-1;if(r<0||this.p.reused[r]!=t){this.p.reused.push(t);r++}var s=this.pos;this.reducePos=this.pos=s+t.length;this.pushState(e,s);this.buffer.push(r,s,this.reducePos,-1);if(this.curContext)this.updateContext(this.curContext.tracker.reuse(this.curContext.context,t,this,this.p.stream.reset(this.pos-t.length)))};t.prototype.split=function(){var e=this;var r=e.buffer.length;while(r>0&&e.buffer[r-2]>e.reducePos)r-=4;var s=e.buffer.slice(r),i=e.bufferBase+r;while(e&&i==e.bufferBase)e=e.parent;return new t(this.p,this.stack.slice(),this.state,this.reducePos,this.pos,this.score,s,i,this.curContext,this.lookAhead,e)};t.prototype.recoverByDelete=function(t,e){var r=t<=this.p.parser.maxNode;if(r)this.storeNode(t,this.pos,e,4);this.storeNode(0,this.pos,e,r?8:4);this.pos=this.reducePos=e;this.score-=190};t.prototype.canShift=function(t){for(var e=new SimulatedStack(this);;){var r=this.p.parser.stateSlot(e.state,4)||this.p.parser.hasAction(e.state,t);if((r&65536)==0)return true;if(r==0)return false;e.reduce(r)}};t.prototype.recoverByInsert=function(t){if(this.stack.length>=300)return[];var e=this.p.parser.nextStates(this.state);if(e.length>4<<1||this.stack.length>=120){var r=[];for(var s=0,i=void 0;s<e.length;s+=2){if((i=e[s+1])!=this.state&&this.p.parser.hasAction(i,t))r.push(e[s],i)}if(this.stack.length<120){var n=function(t){var s=e[t+1];if(!r.some((function(t,e){return e&1&&t==s})))r.push(e[t],s)};for(var s=0;r.length<4<<1&&s<e.length;s+=2){n(s)}}e=r}var o=[];for(var s=0;s<e.length&&o.length<4;s+=2){var i=e[s+1];if(i==this.state)continue;var a=this.split();a.storeNode(0,a.pos,a.pos,4,true);a.pushState(i,this.pos);a.shiftContext(e[s],this.pos);a.score-=200;o.push(a)}return o};t.prototype.forceReduce=function(){var t=this.p.parser.stateSlot(this.state,5);if((t&65536)==0)return false;var e=this.p.parser;if(!e.validAction(this.state,t)){var r=t>>19,s=t&65535;var i=this.stack.length-r*3;if(i<0||e.getGoto(this.stack[i],s,false)<0)return false;this.storeNode(0,this.reducePos,this.reducePos,4,true);this.score-=100}this.reduce(t);return true};t.prototype.forceAll=function(){while(!this.p.parser.stateFlag(this.state,2)){if(!this.forceReduce()){this.storeNode(0,this.pos,this.pos,4,true);break}}return this};Object.defineProperty(t.prototype,"deadEnd",{get:function(){if(this.stack.length!=3)return false;var t=this.p.parser;return t.data[t.stateSlot(this.state,1)]==65535&&!t.stateSlot(this.state,4)},enumerable:false,configurable:true});t.prototype.restart=function(){this.state=this.stack[0];this.stack.length=0};t.prototype.sameState=function(t){if(this.state!=t.state||this.stack.length!=t.stack.length)return false;for(var e=0;e<this.stack.length;e+=3)if(this.stack[e]!=t.stack[e])return false;return true};Object.defineProperty(t.prototype,"parser",{get:function(){return this.p.parser},enumerable:false,configurable:true});t.prototype.dialectEnabled=function(t){return this.p.parser.dialect.flags[t]};t.prototype.shiftContext=function(t,e){if(this.curContext)this.updateContext(this.curContext.tracker.shift(this.curContext.context,t,this,this.p.stream.reset(e)))};t.prototype.reduceContext=function(t,e){if(this.curContext)this.updateContext(this.curContext.tracker.reduce(this.curContext.context,t,this,this.p.stream.reset(e)))};t.prototype.emitContext=function(){var t=this.buffer.length-1;if(t<0||this.buffer[t]!=-3)this.buffer.push(this.curContext.hash,this.reducePos,this.reducePos,-3)};t.prototype.emitLookAhead=function(){var t=this.buffer.length-1;if(t<0||this.buffer[t]!=-4)this.buffer.push(this.lookAhead,this.reducePos,this.reducePos,-4)};t.prototype.updateContext=function(t){if(t!=this.curContext.context){var e=new StackContext(this.curContext.tracker,t);if(e.hash!=this.curContext.hash)this.emitContext();this.curContext=e}};t.prototype.setLookAhead=function(t){if(t>this.lookAhead){this.emitLookAhead();this.lookAhead=t}};t.prototype.close=function(){if(this.curContext&&this.curContext.tracker.strict)this.emitContext();if(this.lookAhead>0)this.emitLookAhead()};return t}();var StackContext=function(){function t(t,e){this.tracker=t;this.context=e;this.hash=t.strict?t.hash(e):0}return t}();var Recover;(function(t){t[t["Insert"]=200]="Insert";t[t["Delete"]=190]="Delete";t[t["Reduce"]=100]="Reduce";t[t["MaxNext"]=4]="MaxNext";t[t["MaxInsertStackDepth"]=300]="MaxInsertStackDepth";t[t["DampenInsertStackDepth"]=120]="DampenInsertStackDepth"})(Recover||(Recover={}));var SimulatedStack=function(){function t(t){this.start=t;this.state=t.state;this.stack=t.stack;this.base=this.stack.length}t.prototype.reduce=function(t){var e=t&65535,r=t>>19;if(r==0){if(this.stack==this.start.stack)this.stack=this.stack.slice();this.stack.push(this.state,0,0);this.base+=3}else{this.base-=(r-1)*3}var s=this.start.p.parser.getGoto(this.stack[this.base-3],e,true);this.state=s};return t}();var StackBufferCursor=function(){function t(t,e,r){this.stack=t;this.pos=e;this.index=r;this.buffer=t.buffer;if(this.index==0)this.maybeNext()}t.create=function(e,r){if(r===void 0){r=e.bufferBase+e.buffer.length}return new t(e,r,r-e.bufferBase)};t.prototype.maybeNext=function(){var t=this.stack.parent;if(t!=null){this.index=this.stack.bufferBase-t.bufferBase;this.stack=t;this.buffer=t.buffer}};Object.defineProperty(t.prototype,"id",{get:function(){return this.buffer[this.index-4]},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"start",{get:function(){return this.buffer[this.index-3]},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"end",{get:function(){return this.buffer[this.index-2]},enumerable:false,configurable:true});Object.defineProperty(t.prototype,"size",{get:function(){return this.buffer[this.index-1]},enumerable:false,configurable:true});t.prototype.next=function(){this.index-=4;this.pos-=4;if(this.index==0)this.maybeNext()};t.prototype.fork=function(){return new t(this.stack,this.pos,this.index)};return t}();var CachedToken=function(){function t(){this.start=-1;this.value=-1;this.end=-1;this.extended=-1;this.lookAhead=0;this.mask=0;this.context=0}return t}();var nullToken=new CachedToken;var InputStream=function(){function t(t,e){this.input=t;this.ranges=e;this.chunk="";this.chunkOff=0;this.chunk2="";this.chunk2Pos=0;this.next=-1;this.token=nullToken;this.rangeIndex=0;this.pos=this.chunkPos=e[0].from;this.range=e[0];this.end=e[e.length-1].to;this.readNext()}t.prototype.resolveOffset=function(t,e){var r=this.range,s=this.rangeIndex;var i=this.pos+t;while(i<r.from){if(!s)return null;var n=this.ranges[--s];i-=r.from-n.to;r=n}while(e<0?i>r.to:i>=r.to){if(s==this.ranges.length-1)return null;var n=this.ranges[++s];i+=n.from-r.to;r=n}return i};t.prototype.peek=function(t){var e=this.chunkOff+t,r,s;if(e>=0&&e<this.chunk.length){r=this.pos+t;s=this.chunk.charCodeAt(e)}else{var i=this.resolveOffset(t,1);if(i==null)return-1;r=i;if(r>=this.chunk2Pos&&r<this.chunk2Pos+this.chunk2.length){s=this.chunk2.charCodeAt(r-this.chunk2Pos)}else{var n=this.rangeIndex,o=this.range;while(o.to<=r)o=this.ranges[++n];this.chunk2=this.input.chunk(this.chunk2Pos=r);if(r+this.chunk2.length>o.to)this.chunk2=this.chunk2.slice(0,o.to-r);s=this.chunk2.charCodeAt(0)}}if(r>=this.token.lookAhead)this.token.lookAhead=r+1;return s};t.prototype.acceptToken=function(t,e){if(e===void 0){e=0}var r=e?this.resolveOffset(e,-1):this.pos;if(r==null||r<this.token.start)throw new RangeError("Token end out of bounds");this.token.value=t;this.token.end=r};t.prototype.getChunk=function(){if(this.pos>=this.chunk2Pos&&this.pos<this.chunk2Pos+this.chunk2.length){var t=this,e=t.chunk,r=t.chunkPos;this.chunk=this.chunk2;this.chunkPos=this.chunk2Pos;this.chunk2=e;this.chunk2Pos=r;this.chunkOff=this.pos-this.chunkPos}else{this.chunk2=this.chunk;this.chunk2Pos=this.chunkPos;var s=this.input.chunk(this.pos);var i=this.pos+s.length;this.chunk=i>this.range.to?s.slice(0,this.range.to-this.pos):s;this.chunkPos=this.pos;this.chunkOff=0}};t.prototype.readNext=function(){if(this.chunkOff>=this.chunk.length){this.getChunk();if(this.chunkOff==this.chunk.length)return this.next=-1}return this.next=this.chunk.charCodeAt(this.chunkOff)};t.prototype.advance=function(t){if(t===void 0){t=1}this.chunkOff+=t;while(this.pos+t>=this.range.to){if(this.rangeIndex==this.ranges.length-1)return this.setDone();t-=this.range.to-this.pos;this.range=this.ranges[++this.rangeIndex];this.pos=this.range.from}this.pos+=t;if(this.pos>=this.token.lookAhead)this.token.lookAhead=this.pos+1;return this.readNext()};t.prototype.setDone=function(){this.pos=this.chunkPos=this.end;this.range=this.ranges[this.rangeIndex=this.ranges.length-1];this.chunk="";return this.next=-1};t.prototype.reset=function(t,e){if(e){this.token=e;e.start=t;e.lookAhead=t+1;e.value=e.extended=-1}else{this.token=nullToken}if(this.pos!=t){this.pos=t;if(t==this.end){this.setDone();return this}while(t<this.range.from)this.range=this.ranges[--this.rangeIndex];while(t>=this.range.to)this.range=this.ranges[++this.rangeIndex];if(t>=this.chunkPos&&t<this.chunkPos+this.chunk.length){this.chunkOff=t-this.chunkPos}else{this.chunk="";this.chunkOff=0}this.readNext()}return this};t.prototype.read=function(t,e){if(t>=this.chunkPos&&e<=this.chunkPos+this.chunk.length)return this.chunk.slice(t-this.chunkPos,e-this.chunkPos);if(t>=this.chunk2Pos&&e<=this.chunk2Pos+this.chunk2.length)return this.chunk2.slice(t-this.chunk2Pos,e-this.chunk2Pos);if(t>=this.range.from&&e<=this.range.to)return this.input.read(t,e);var r="";for(var s=0,i=this.ranges;s<i.length;s++){var n=i[s];if(n.from>=e)break;if(n.to>t)r+=this.input.read(Math.max(n.from,t),Math.min(n.to,e))}return r};return t}();var TokenGroup=function(){function t(t,e){this.data=t;this.id=e}t.prototype.token=function(t,e){readToken(this.data,t,e,this.id)};return t}();TokenGroup.prototype.contextual=TokenGroup.prototype.fallback=TokenGroup.prototype.extend=false;var ExternalTokenizer=function(){function t(t,e){if(e===void 0){e={}}this.token=t;this.contextual=!!e.contextual;this.fallback=!!e.fallback;this.extend=!!e.extend}return t}();function readToken(t,e,r,s){var i=0,n=1<<s,o=r.p.parser,a=o.dialect;t:for(;;){if((n&t[i])==0)break;var h=t[i+1];for(var f=i+3;f<h;f+=2)if((t[f+1]&n)>0){var u=t[f];if(a.allows(u)&&(e.token.value==-1||e.token.value==u||o.overrides(u,e.token.value))){e.acceptToken(u);break}}for(var c=e.next,p=0,l=t[i+2];p<l;){var d=p+l>>1;var v=h+d+(d<<1);var k=t[v],g=t[v+1];if(c<k)l=d;else if(c>=g)p=d+1;else{i=t[v+2];e.advance();continue t}}break}}function decodeArray(t,e){if(e===void 0){e=Uint16Array}if(typeof t!="string")return t;var r=null;for(var s=0,i=0;s<t.length;){var n=0;for(;;){var o=t.charCodeAt(s++),a=false;if(o==126){n=65535;break}if(o>=92)o--;if(o>=34)o--;var h=o-32;if(h>=46){h-=46;a=true}n+=h;if(a)break;n*=46}if(r)r[i++]=n;else r=new e(n)}return r}var verbose=typeof process!="undefined"&&/\bparse\b/.test(process.env.LOG);var stackIDs=null;var Safety;(function(t){t[t["Margin"]=25]="Margin"})(Safety||(Safety={}));function cutAt(t,e,r){var s=t.fullCursor();s.moveTo(e);for(;;){if(!(r<0?s.childBefore(e):s.childAfter(e)))for(;;){if((r<0?s.to<e:s.from>e)&&!s.type.isError)return r<0?Math.max(0,Math.min(s.to-1,e-25)):Math.min(t.length,Math.max(s.from+1,e+25));if(r<0?s.prevSibling():s.nextSibling())break;if(!s.parent())return r<0?0:t.length}}}var FragmentCursor=function(){function t(t,e){this.fragments=t;this.nodeSet=e;this.i=0;this.fragment=null;this.safeFrom=-1;this.safeTo=-1;this.trees=[];this.start=[];this.index=[];this.nextFragment()}t.prototype.nextFragment=function(){var t=this.fragment=this.i==this.fragments.length?null:this.fragments[this.i++];if(t){this.safeFrom=t.openStart?cutAt(t.tree,t.from+t.offset,1)-t.offset:t.from;this.safeTo=t.openEnd?cutAt(t.tree,t.to+t.offset,-1)-t.offset:t.to;while(this.trees.length){this.trees.pop();this.start.pop();this.index.pop()}this.trees.push(t.tree);this.start.push(-t.offset);this.index.push(0);this.nextStart=this.safeFrom}else{this.nextStart=1e9}};t.prototype.nodeAt=function(t){if(t<this.nextStart)return null;while(this.fragment&&this.safeTo<=t)this.nextFragment();if(!this.fragment)return null;for(;;){var e=this.trees.length-1;if(e<0){this.nextFragment();return null}var r=this.trees[e],s=this.index[e];if(s==r.children.length){this.trees.pop();this.start.pop();this.index.pop();continue}var i=r.children[s];var n=this.start[e]+r.positions[s];if(n>t){this.nextStart=n;return null}if(i instanceof Tree){if(n==t){if(n<this.safeFrom)return null;var o=n+i.length;if(o<=this.safeTo){var a=i.prop(NodeProp.lookAhead);if(!a||o+a<this.fragment.to)return i}}this.index[e]++;if(n+i.length>=Math.max(this.safeFrom,t)){this.trees.push(i);this.start.push(n);this.index.push(0)}}else{this.index[e]++;this.nextStart=n+i.length}}};return t}();var TokenCache=function(){function t(t,e){this.stream=e;this.tokens=[];this.mainToken=null;this.actions=[];this.tokens=t.tokenizers.map((function(t){return new CachedToken}))}t.prototype.getActions=function(t){var e=0;var r=null;var s=t.p.parser,i=s.tokenizers;var n=s.stateSlot(t.state,3);var o=t.curContext?t.curContext.hash:0;var a=0;for(var h=0;h<i.length;h++){if((1<<h&n)==0)continue;var f=i[h],u=this.tokens[h];if(r&&!f.fallback)continue;if(f.contextual||u.start!=t.pos||u.mask!=n||u.context!=o){this.updateCachedToken(u,f,t);u.mask=n;u.context=o}if(u.lookAhead>u.end+25)a=Math.max(u.lookAhead,a);if(u.value!=0){var c=e;if(u.extended>-1)e=this.addActions(t,u.extended,u.end,e);e=this.addActions(t,u.value,u.end,e);if(!f.extend){r=u;if(e>c)break}}}while(this.actions.length>e)this.actions.pop();if(a)t.setLookAhead(a);if(!r&&t.pos==this.stream.end){r=new CachedToken;r.value=t.p.parser.eofTerm;r.start=r.end=t.pos;e=this.addActions(t,r.value,r.end,e)}this.mainToken=r;return this.actions};t.prototype.getMainToken=function(t){if(this.mainToken)return this.mainToken;var e=new CachedToken,r=t.pos,s=t.p;e.start=r;e.end=Math.min(r+1,s.stream.end);e.value=r==s.stream.end?s.parser.eofTerm:0;return e};t.prototype.updateCachedToken=function(t,e,r){e.token(this.stream.reset(r.pos,t),r);if(t.value>-1){var s=r.p.parser;for(var i=0;i<s.specialized.length;i++)if(s.specialized[i]==t.value){var n=s.specializers[i](this.stream.read(t.start,t.end),r);if(n>=0&&r.p.parser.dialect.allows(n>>1)){if((n&1)==0)t.value=n>>1;else t.extended=n>>1;break}}}else{t.value=0;t.end=Math.min(r.p.stream.end,r.pos+1)}};t.prototype.putAction=function(t,e,r,s){for(var i=0;i<s;i+=3)if(this.actions[i]==t)return s;this.actions[s++]=t;this.actions[s++]=e;this.actions[s++]=r;return s};t.prototype.addActions=function(t,e,r,s){var i=t.state,n=t.p.parser,o=n.data;for(var a=0;a<2;a++){for(var h=n.stateSlot(i,a?2:1);;h+=3){if(o[h]==65535){if(o[h+1]==1){h=pair(o,h+2)}else{if(s==0&&o[h+1]==2)s=this.putAction(pair(o,h+2),e,r,s);break}}if(o[h]==e)s=this.putAction(pair(o,h+1),e,r,s)}}return s};return t}();var Rec;(function(t){t[t["Distance"]=5]="Distance";t[t["MaxRemainingPerStep"]=3]="MaxRemainingPerStep";t[t["MinBufferLengthPrune"]=500]="MinBufferLengthPrune";t[t["ForceReduceLimit"]=10]="ForceReduceLimit";t[t["CutDepth"]=15e3]="CutDepth";t[t["CutTo"]=9e3]="CutTo"})(Rec||(Rec={}));var Parse=function(){function t(t,e,r,s){this.parser=t;this.input=e;this.ranges=s;this.recovering=0;this.nextStackID=9812;this.minStackPos=0;this.reused=[];this.stoppedAt=null;this.stream=new InputStream(e,s);this.tokens=new TokenCache(t,this.stream);this.topTerm=t.top[1];var i=s[0].from;this.stacks=[Stack.start(this,t.top[0],i)];this.fragments=r.length&&this.stream.end-i>t.bufferLength*4?new FragmentCursor(r,t.nodeSet):null}Object.defineProperty(t.prototype,"parsedPos",{get:function(){return this.minStackPos},enumerable:false,configurable:true});t.prototype.advance=function(){var t=this.stacks,e=this.minStackPos;var r=this.stacks=[];var s,i;for(var n=0;n<t.length;n++){var o=t[n];for(;;){this.tokens.mainToken=null;if(o.pos>e){r.push(o)}else if(this.advanceStack(o,r,t)){continue}else{if(!s){s=[];i=[]}s.push(o);var a=this.tokens.getMainToken(o);i.push(a.value,a.end)}break}}if(!r.length){var h=s&&findFinished(s);if(h)return this.stackToTree(h);if(this.parser.strict){if(verbose&&s)console.log("Stuck with token "+(this.tokens.mainToken?this.parser.getName(this.tokens.mainToken.value):"none"));throw new SyntaxError("No parse at "+e)}if(!this.recovering)this.recovering=5}if(this.recovering&&s){var h=this.stoppedAt!=null&&s[0].pos>this.stoppedAt?s[0]:this.runRecovery(s,i,r);if(h)return this.stackToTree(h.forceAll())}if(this.recovering){var f=this.recovering==1?1:this.recovering*3;if(r.length>f){r.sort((function(t,e){return e.score-t.score}));while(r.length>f)r.pop()}if(r.some((function(t){return t.reducePos>e})))this.recovering--}else if(r.length>1){t:for(var n=0;n<r.length-1;n++){var o=r[n];for(var u=n+1;u<r.length;u++){var c=r[u];if(o.sameState(c)||o.buffer.length>500&&c.buffer.length>500){if((o.score-c.score||o.buffer.length-c.buffer.length)>0){r.splice(u--,1)}else{r.splice(n--,1);continue t}}}}}this.minStackPos=r[0].pos;for(var n=1;n<r.length;n++)if(r[n].pos<this.minStackPos)this.minStackPos=r[n].pos;return null};t.prototype.stopAt=function(t){if(this.stoppedAt!=null&&this.stoppedAt<t)throw new RangeError("Can't move stoppedAt forward");this.stoppedAt=t};t.prototype.advanceStack=function(t,e,r){var s=t.pos,i=this.parser;var n=verbose?this.stackID(t)+" -> ":"";if(this.stoppedAt!=null&&s>this.stoppedAt)return t.forceReduce()?t:null;if(this.fragments){var o=t.curContext&&t.curContext.tracker.strict,a=o?t.curContext.hash:0;for(var h=this.fragments.nodeAt(s);h;){var f=this.parser.nodeSet.types[h.type.id]==h.type?i.getGoto(t.state,h.type.id):-1;if(f>-1&&h.length&&(!o||(h.prop(NodeProp.contextHash)||0)==a)){t.useNode(h,f);if(verbose)console.log(n+this.stackID(t)+" (via reuse of ".concat(i.getName(h.type.id),")"));return true}if(!(h instanceof Tree)||h.children.length==0||h.positions[0]>0)break;var u=h.children[0];if(u instanceof Tree&&h.positions[0]==0)h=u;else break}}var c=i.stateSlot(t.state,4);if(c>0){t.reduce(c);if(verbose)console.log(n+this.stackID(t)+" (via always-reduce ".concat(i.getName(c&65535),")"));return true}if(t.stack.length>=15e3){while(t.stack.length>9e3&&t.forceReduce()){}}var p=this.tokens.getActions(t);for(var l=0;l<p.length;){var d=p[l++],v=p[l++],k=p[l++];var g=l==p.length||!r;var m=g?t:t.split();m.apply(d,v,k);if(verbose)console.log(n+this.stackID(m)+" (via ".concat((d&65536)==0?"shift":"reduce of ".concat(i.getName(d&65535))," for ").concat(i.getName(v)," @ ").concat(s).concat(m==t?"":", split",")"));if(g)return true;else if(m.pos>s)e.push(m);else r.push(m)}return false};t.prototype.advanceFully=function(t,e){var r=t.pos;for(;;){if(!this.advanceStack(t,null,null))return false;if(t.pos>r){pushStackDedup(t,e);return true}}};t.prototype.runRecovery=function(t,e,r){var s=null,i=false;for(var n=0;n<t.length;n++){var o=t[n],a=e[n<<1],h=e[(n<<1)+1];var f=verbose?this.stackID(o)+" -> ":"";if(o.deadEnd){if(i)continue;i=true;o.restart();if(verbose)console.log(f+this.stackID(o)+" (restarted)");var u=this.advanceFully(o,r);if(u)continue}var c=o.split(),p=f;for(var l=0;c.forceReduce()&&l<10;l++){if(verbose)console.log(p+this.stackID(c)+" (via force-reduce)");var u=this.advanceFully(c,r);if(u)break;if(verbose)p=this.stackID(c)+" -> "}for(var d=0,v=o.recoverByInsert(a);d<v.length;d++){var k=v[d];if(verbose)console.log(f+this.stackID(k)+" (via recover-insert)");this.advanceFully(k,r)}if(this.stream.end>o.pos){if(h==o.pos){h++;a=0}o.recoverByDelete(a,h);if(verbose)console.log(f+this.stackID(o)+" (via recover-delete ".concat(this.parser.getName(a),")"));pushStackDedup(o,r)}else if(!s||s.score<o.score){s=o}}return s};t.prototype.stackToTree=function(t){t.close();return Tree.build({buffer:StackBufferCursor.create(t),nodeSet:this.parser.nodeSet,topID:this.topTerm,maxBufferLength:this.parser.bufferLength,reused:this.reused,start:this.ranges[0].from,length:t.pos-this.ranges[0].from,minRepeatType:this.parser.minRepeatTerm})};t.prototype.stackID=function(t){var e=(stackIDs||(stackIDs=new WeakMap)).get(t);if(!e)stackIDs.set(t,e=String.fromCodePoint(this.nextStackID++));return e+t};return t}();function pushStackDedup(t,e){for(var r=0;r<e.length;r++){var s=e[r];if(s.pos==t.pos&&s.sameState(t)){if(e[r].score<t.score)e[r]=t;return}}e.push(t)}var Dialect=function(){function t(t,e,r){this.source=t;this.flags=e;this.disabled=r}t.prototype.allows=function(t){return!this.disabled||this.disabled[t]==0};return t}();var id=function(t){return t};var ContextTracker=function(){function t(t){this.start=t.start;this.shift=t.shift||id;this.reduce=t.reduce||id;this.reuse=t.reuse||id;this.hash=t.hash||function(){return 0};this.strict=t.strict!==false}return t}();var LRParser=function(t){__extends(e,t);function e(e){var r=t.call(this)||this;r.wrappers=[];if(e.version!=13)throw new RangeError("Parser version (".concat(e.version,") doesn't match runtime version (").concat(13,")"));var s=e.nodeNames.split(" ");r.minRepeatTerm=s.length;for(var i=0;i<e.repeatNodeCount;i++)s.push("");var n=Object.keys(e.topRules).map((function(t){return e.topRules[t][1]}));var o=[];for(var i=0;i<s.length;i++)o.push([]);function a(t,e,r){o[t].push([e,e.deserialize(String(r))])}if(e.nodeProps)for(var h=0,f=e.nodeProps;h<f.length;h++){var u=f[h];var c=u[0];for(var i=1;i<u.length;){var p=u[i++];if(p>=0){a(p,c,u[i++])}else{var l=u[i+-p];for(var d=-p;d>0;d--)a(u[i++],c,l);i++}}}r.nodeSet=new NodeSet(s.map((function(t,s){return NodeType.define({name:s>=r.minRepeatTerm?undefined:t,id:s,props:o[s],top:n.indexOf(s)>-1,error:s==0,skipped:e.skippedNodes&&e.skippedNodes.indexOf(s)>-1})})));r.strict=false;r.bufferLength=DefaultBufferLength;var v=decodeArray(e.tokenData);r.context=e.context;r.specialized=new Uint16Array(e.specialized?e.specialized.length:0);r.specializers=[];if(e.specialized)for(var i=0;i<e.specialized.length;i++){r.specialized[i]=e.specialized[i].term;r.specializers[i]=e.specialized[i].get}r.states=decodeArray(e.states,Uint32Array);r.data=decodeArray(e.stateData);r.goto=decodeArray(e.goto);r.maxTerm=e.maxTerm;r.tokenizers=e.tokenizers.map((function(t){return typeof t=="number"?new TokenGroup(v,t):t}));r.topRules=e.topRules;r.dialects=e.dialects||{};r.dynamicPrecedences=e.dynamicPrecedences||null;r.tokenPrecTable=e.tokenPrec;r.termNames=e.termNames||null;r.maxNode=r.nodeSet.types.length-1;r.dialect=r.parseDialect();r.top=r.topRules[Object.keys(r.topRules)[0]];return r}e.prototype.createParse=function(t,e,r){var s=new Parse(this,t,e,r);for(var i=0,n=this.wrappers;i<n.length;i++){var o=n[i];s=o(s,t,e,r)}return s};e.prototype.getGoto=function(t,e,r){if(r===void 0){r=false}var s=this.goto;if(e>=s[0])return-1;for(var i=s[e+1];;){var n=s[i++],o=n&1;var a=s[i++];if(o&&r)return a;for(var h=i+(n>>1);i<h;i++)if(s[i]==t)return a;if(o)return-1}};e.prototype.hasAction=function(t,e){var r=this.data;for(var s=0;s<2;s++){for(var i=this.stateSlot(t,s?2:1),n=void 0;;i+=3){if((n=r[i])==65535){if(r[i+1]==1)n=r[i=pair(r,i+2)];else if(r[i+1]==2)return pair(r,i+2);else break}if(n==e||n==0)return pair(r,i+1)}}return 0};e.prototype.stateSlot=function(t,e){return this.states[t*6+e]};e.prototype.stateFlag=function(t,e){return(this.stateSlot(t,0)&e)>0};e.prototype.validAction=function(t,e){if(e==this.stateSlot(t,4))return true;for(var r=this.stateSlot(t,1);;r+=3){if(this.data[r]==65535){if(this.data[r+1]==1)r=pair(this.data,r+2);else return false}if(e==pair(this.data,r+1))return true}};e.prototype.nextStates=function(t){var e=[];var r=function(t){if(s.data[t]==65535){if(s.data[t+1]==1)t=pair(s.data,t+2);else return i=t,"break"}if((s.data[t+2]&65536>>16)==0){var r=s.data[t+1];if(!e.some((function(t,e){return e&1&&t==r})))e.push(s.data[t],r)}i=t};var s=this,i;for(var n=this.stateSlot(t,1);;n+=3){var o=r(n);n=i;if(o==="break")break}return e};e.prototype.overrides=function(t,e){var r=findOffset(this.data,this.tokenPrecTable,e);return r<0||findOffset(this.data,this.tokenPrecTable,t)<r};e.prototype.configure=function(t){var r;var s=Object.assign(Object.create(e.prototype),this);if(t.props)s.nodeSet=(r=this.nodeSet).extend.apply(r,t.props);if(t.top){var i=this.topRules[t.top];if(!i)throw new RangeError("Invalid top rule name ".concat(t.top));s.top=i}if(t.tokenizers)s.tokenizers=this.tokenizers.map((function(e){var r=t.tokenizers.find((function(t){return t.from==e}));return r?r.to:e}));if(t.contextTracker)s.context=t.contextTracker;if(t.dialect)s.dialect=this.parseDialect(t.dialect);if(t.strict!=null)s.strict=t.strict;if(t.wrap)s.wrappers=s.wrappers.concat(t.wrap);if(t.bufferLength!=null)s.bufferLength=t.bufferLength;return s};e.prototype.getName=function(t){return this.termNames?this.termNames[t]:String(t<=this.maxNode&&this.nodeSet.types[t].name||t)};Object.defineProperty(e.prototype,"eofTerm",{get:function(){return this.maxNode+1},enumerable:false,configurable:true});Object.defineProperty(e.prototype,"topNode",{get:function(){return this.nodeSet.types[this.top[1]]},enumerable:false,configurable:true});e.prototype.dynamicPrecedence=function(t){var e=this.dynamicPrecedences;return e==null?0:e[t]||0};e.prototype.parseDialect=function(t){var e=Object.keys(this.dialects),r=e.map((function(){return false}));if(t)for(var s=0,i=t.split(" ");s<i.length;s++){var n=i[s];var o=e.indexOf(n);if(o>=0)r[o]=true}var a=null;for(var h=0;h<e.length;h++)if(!r[h]){for(var f=this.dialects[e[h]],u;(u=this.data[f++])!=65535;)(a||(a=new Uint8Array(this.maxTerm+1)))[u]=1}return new Dialect(t,r,a)};e.deserialize=function(t){return new e(t)};return e}(Parser);function pair(t,e){return t[e]|t[e+1]<<16}function findOffset(t,e,r){for(var s=e,i=void 0;(i=t[s])!=65535;s++)if(i==r)return s-e;return-1}function findFinished(t){var e=null;for(var r=0,s=t;r<s.length;r++){var i=s[r];var n=i.p.stoppedAt;if((i.pos==i.p.stream.end||n!=null&&i.pos>n)&&i.p.parser.stateFlag(i.state,2)&&(!e||e.score<i.score))e=i}return e}export{ContextTracker as C,ExternalTokenizer as E,LRParser as L};
//# sourceMappingURL=index-82af852d.js.map